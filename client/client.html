<!DOCTYPE html>
<html lang="en">
<head>
    <title>Low Roar</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
        const handleResponse = async (response, parseResponse, sectionID) => {
            // Each div has it's own sectionID. We take it in so that we can make sure
            // whatever data we have goes to the right place.
            const content = document.querySelector(`#${sectionID}`);

            switch(response.status) {
                case 200: 
                content.innerHTML = `<b>Success</b>`;
                break;
                case 201:
                content.innerHTML = `<b>Created</b>`;
                break;
                case 204:
                content.innerHTML = `<b>Updated (No Content)</b>`;
                break;
                case 400: 
                content.innerHTML = `<b>Bad Request</b>`;
                break;
                case 404:
                content.innerHTML = `<b>Not Found</b>`;
                break;
                default: 
                content.innerHTML = `Error code not implemented by client.`;
                break;
            }
            console.log("parse: " + parseResponse)
            if (parseResponse) {
                let obj = await response.json();

                if (sectionID === 'get-albums' && response.status === 200){
                    albumHTML(content, obj);
                } else if (sectionID === 'get-songs' && response.status === 200)  {
                    songHTML(content, obj);
                } else if (sectionID === 'search-for-album' && response.status === 200) {
                    albumHTML(content, obj);
                } else if (sectionID === 'search-for-song' && response.status === 200) {
                    songHTML(content, obj);
                }else if (sectionID === 'get-by-lyrics' && response.status === 200) {
                    songHTML(content, obj);
                }
                console.log(obj.message);
                if (obj.message) {
                    content.innerHTML += `<p>Message: ${obj.message}</p>`;
                }
            }
        };

        const albumHTML = (content, obj) => {
            content.innerHTML += `<h3>Low Roar Album Search</h3>`;
            obj.forEach(album => {
                content.innerHTML += `
                <div class="album">
                    <img src="${album.CoverImage}" alt="The album cover for Low Roar's ${album.AlbumTitle}" width="100"><br>
                    <h4>${album.AlbumTitle} (${album.Released})</h4>
                    <b>Label: </b>${album.Label}<br>
                    <b>Length: </b>${album.Length}<br>
                    <div class="newlines"> ${album.Description}</div><br>
                    <a href="${album.YoutubeURL}" target="_blank">YouTube</a> |
                    <a href="${album.SpotifyURL}" target="_blank">Spotify</a> |
                    <a href="${album.AppleURL}" target="_blank">Apple</a> |
                    <a href="${album.WikiURL}" target="_blank">Wikipedia</a>
                    <hr>
                </div>
                `;
            });
        };

        const songHTML = (content, obj) => {
            content.innerHTML += `<h3>Low Roar Songs</h3>`;
            obj.forEach(song => {
                content.innerHTML += `
                <div class="song">
                    <img src="${song.CoverImage}" alt="${song.SongName}'s album's cover image." width="100"><br>
                    <h2>${song.SongName}</h2>`;
                    if (song.Rating) { content.innerHTML += `<b>Rating: </b>${song.Rating}`};
                    content.innerHTML +=` 
                    <b>Length: </b>${song.Length}<br>
                    <b>Lyrics</b><br><div class="newlines">${song.Lyrics}</div>
                    <hr>
                </div>
                `;
            });
        };



        const requestUpdate = async (userForm, sectionID) => {
            let url = userForm.getAttribute('action');
            const method = userForm.querySelector('#methodSelect').value;
            const params = new URLSearchParams(new FormData(userForm)).toString();
            url += `?${params}`;
            let response = await fetch(url, {
                method,
                headers: {
                    'Accept': 'application/json'
                },
            });

            handleResponse(response, method === 'get', sectionID);
        };

        const sendPost = async (nameForm, sectionID) => {
            const url = nameForm.getAttribute('action');
            const method = nameForm.getAttribute('method');
            
            let titleField;
            let lengthField;
            let rateTitleField;
            let rateField;
            let formData;
            if (nameForm === addYourOwnSongForm) {
                titleField = nameForm.querySelector("#yourTitleField");
                lengthField = nameForm.querySelector("#yourLengthField");
                formData = `title=${titleField.value}&length=${lengthField.value}`;
            } else if (nameForm === rateSongForm) {
                rateTitleField = nameForm.querySelector("#rateTitleField");
                rateField = nameForm.querySelector("#rateField");
                formData = `title=${rateTitleField.value}&rating=${rateField.value}`;
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json',
                },
                body: formData,
            });

            handleResponse(response, true, sectionID);
        };

        const init = () => {
            const albumsForm = document.querySelector('#albumsForm');
            const songsForm = document.querySelector('#songsForm');
            const albumSearchForm = document.querySelector('#albumSearchForm');
            const songSearchForm = document.querySelector('#songSearchForm');
            const lyricalSearchForm = document.querySelector('#lyricalSearchForm');

            const addYourOwnSongForm = document.querySelector('#addYourOwnSongForm');
            const rateSongForm = document.querySelector('#rateSongForm');

        
            const getAlbums = (e) => {
                e.preventDefault();
                console.log(e.target);
                requestUpdate(albumsForm, 'get-albums');
                return false;
            }
            const getSongs = (e) => {
                e.preventDefault();
                requestUpdate(songsForm, 'get-songs');
                return false;
            }
            const albumSearch = (e) => {
                e.preventDefault();
                requestUpdate(albumSearchForm, 'search-for-album');
                return false;
            }
            const songSearch = (e) => {
                e.preventDefault();
                requestUpdate(songSearchForm, 'search-for-song');
                return false;
            }
            const lyricalSearch = (e) => {
                e.preventDefault();
                requestUpdate(lyricalSearchForm, 'get-by-lyrics');
                return false;
            }

            const addSong = (e) => {
                e.preventDefault();
                sendPost(addYourOwnSongForm, 'post-song');
                return false;
            }
            const addRating = (e) => {
                e.preventDefault();
                sendPost(rateSongForm, 'post-rating');
                return false;
            }
        
            // get forms
            albumsForm.addEventListener('submit', getAlbums);
            songsForm.addEventListener('submit', getSongs);
            albumSearchForm.addEventListener('submit', albumSearch);
            songSearchForm.addEventListener('submit', songSearch);
            lyricalSearchForm.addEventListener('submit', lyricalSearch);
            // post forms
            addYourOwnSongForm.addEventListener('submit', addSong);
            rateSongForm.addEventListener('submit', addRating);
        };

        window.onload = init;
    </script>

</head>

<body>
    <h2 class="websiteTitle">Low Roar</h2>
    <div class="apiAccess">
        <!-- In here, we will simply return all albums..-->
        <h2>All Albums</h2>
        <form id="albumsForm" action="/getAlbums" method="get">
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Search" />
        </form>
        <div class="content-block">
            <section id="get-albums">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will simply return all songs.-->
        <h2>All Songs</h2>
        <form id="songsForm" action="/getSongs" method="get">
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Search" />
        </form>
        <div class="content-block">
            <section id="get-songs">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will return a Low Roar Album by title and/or by year. -->
        <h2>Album Search</h3>
        <form id="albumSearchForm" action="/albumSearch" method="get">
            <label for="title">Title: </label>
            <input id="albumTitleField" type="text" name="title"/>
            <label for="year">Year: </label>
            <input id="albumYearField" type="text" name="year"/>
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Search" />
        </form>
        <div class="content-block">
            <section id="search-for-album">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will search for Low Roar Albums by title and/or by year. -->
        <h2>Song Search</h3>
        <form id="songSearchForm" action="/songSearch" method="get">
            <label for="title">Title: </label>
            <input id="songTitleField" type="text" name="title"/>
            <label for="year">Year: </label>
            <input id="songYearField" type="text" name="year"/>
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Search" />
        </form>
        <div class="content-block">
            <section id="search-for-song">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will search for a Low Roar song by it's lyrics.-->
        <h2>Lyrical Search</h2>
        <form id="lyricalSearchForm" action="/getSongFromLyrics" method="get">
            <label for="lyrics">Lyrics: </label>
            <input id="lyricField" type="text" name="lyrics"/>
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Search" />
        </form>
        <div class="content-block">
            <section id="get-by-lyrics">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will add a song by it's title and author.-->
        <h2>Add Your Own Song</h2>
        <form id="addYourOwnSongForm" action="/addSong" method="post">
            <label for="title">Title: </label>
            <input id="yourTitleField" type="text" name="title"/>
            <label for="length">Length: </label>
            <input id="yourLengthField" type="text" name="length"/>
            <input type="submit" value="Add Song" />
        </form>
        <div class="content-block">
            <section id="post-song">
            </section>
        </div>
    </div>
    <div class="apiAccess">
        <!-- In here, we will add a rating to a song already in the dataset..-->
        <h2>Rate Song</h2>
        <form id="rateSongForm" action="/rateSong" method="post">
            <label for="title">Title: </label>
            <input id="rateTitleField" type="text" name="title"/>
            <label for="rating">Rating: </label>
            <input id="rateField" type="number" name="rating" min="1" max="5" step="1"/>
            <input type="submit" value="Submit Rating" />
        </form>
        <div class="content-block">
            <section id="post-rating">
            </section>
        </div>
    </div>




</body>
</html>
